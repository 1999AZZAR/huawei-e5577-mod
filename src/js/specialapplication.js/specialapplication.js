var SPECIAL_APP_NUM=16,ok_flag=0,add_flag=0,filterStatusArray=[[FILTER_DISABLED,common_off],[FILTER_ENABLED,common_on]],protocolStatusArray=[[PROTOCOL_BOTH,firewall_label_tcp_or_udp],[PROTOCOL_TCP,firewall_label_tcp],[PROTOCOL_UDP,firewall_label_udp]];function initInput(){$("#sa_trigger_status").val(FILTER_DISABLED),$("#sa_trigger_protocol").val(PROTOCOL_BOTH),$("#sa_open_protocol").val(PROTOCOL_BOTH)}function initPage(){SPECIAL_APP_NUM=parseInt(g_config_firewall.specialapplication.number,10),button_enable("apply","0"),$(".user_add_line").remove(),initInput(),getAjaxData("api/security/special-applications",(function(t){var e,a,i=xml2object(t);if(i=i.response.LanPorts.LanPort){var r=[];i.length>=SPECIAL_APP_NUM&&button_enable("add_item","0"),$.isArray(i)?($(i).each((function(t){i[t].SpecialApplicationStartOpenPort0.length>0&&"0"!=i[t].SpecialApplicationStartOpenPort0&&r.push(portJoin(i[t].SpecialApplicationStartOpenPort0,i[t].SpecialApplicationEndOpenPort0)),i[t].SpecialApplicationStartOpenPort1.length>0&&"0"!=i[t].SpecialApplicationStartOpenPort1&&r.push(portJoin(i[t].SpecialApplicationStartOpenPort1,i[t].SpecialApplicationEndOpenPort1)),i[t].SpecialApplicationStartOpenPort2.length>0&&"0"!=i[t].SpecialApplicationStartOpenPort2&&r.push(portJoin(i[t].SpecialApplicationStartOpenPort2,i[t].SpecialApplicationEndOpenPort2)),i[t].SpecialApplicationStartOpenPort3.length>0&&"0"!=i[t].SpecialApplicationStartOpenPort3&&r.push(portJoin(i[t].SpecialApplicationStartOpenPort3,i[t].SpecialApplicationEndOpenPort3)),i[t].SpecialApplicationStartOpenPort4.length>0&&"0"!=i[t].SpecialApplicationStartOpenPort4&&r.push(portJoin(i[t].SpecialApplicationStartOpenPort4,i[t].SpecialApplicationEndOpenPort4)),addFilter($("#service_list tr"),spaceToNbsp(XSSResolveCannotParseChar(i[t].SpecialApplicationTriggerName)),getDArrayElement(filterStatusArray,i[t].SpecialApplicationTriggerStatus,"value"),i[t].SpecialApplicationTriggerPort,getDArrayElement(protocolStatusArray,i[t].SpecialApplicationTriggerProtocol,"value"),getDArrayElement(protocolStatusArray,i[t].SpecialApplicationOpenProtocol,"value"),r.join(";")),i.length-1==t&&(a=r.join(";")),r=[]})),e=i[i.length-1]):(i.SpecialApplicationStartOpenPort0.length>0&&"0"!=i.SpecialApplicationStartOpenPort0&&r.push(portJoin(i.SpecialApplicationStartOpenPort0,i.SpecialApplicationEndOpenPort0)),i.SpecialApplicationStartOpenPort1.length>0&&"0"!=i.SpecialApplicationStartOpenPort1&&r.push(portJoin(i.SpecialApplicationStartOpenPort1,i.SpecialApplicationEndOpenPort1)),i.SpecialApplicationStartOpenPort2.length>0&&"0"!=i.SpecialApplicationStartOpenPort2&&r.push(portJoin(i.SpecialApplicationStartOpenPort2,i.SpecialApplicationEndOpenPort2)),i.SpecialApplicationStartOpenPort3.length>0&&"0"!=i.SpecialApplicationStartOpenPort3&&r.push(portJoin(i.SpecialApplicationStartOpenPort3,i.SpecialApplicationEndOpenPort3)),i.SpecialApplicationStartOpenPort4.length>0&&"0"!=i.SpecialApplicationStartOpenPort4&&r.push(portJoin(i.SpecialApplicationStartOpenPort4,i.SpecialApplicationEndOpenPort4)),addFilter($("#service_list tr"),spaceToNbsp(XSSResolveCannotParseChar(i.SpecialApplicationTriggerName)),getDArrayElement(filterStatusArray,i.SpecialApplicationTriggerStatus,"value"),i.SpecialApplicationTriggerPort,getDArrayElement(protocolStatusArray,i.SpecialApplicationTriggerProtocol,"value"),getDArrayElement(protocolStatusArray,i.SpecialApplicationOpenProtocol,"value"),r.join(";")),e=i,a=r.join(";")),$("#sa_trigger_name").val(e.SpecialApplicationTriggerName),$("#sa_trigger_port").val(e.SpecialApplicationTriggerPort),$("#sa_open_port").val(a)}else $("#sa_trigger_name").val(""),$("#sa_trigger_port").val(""),$("#sa_open_port").val("")}))}function comparePort(t,e){var a=[];for($(".user_add_line").each((function(t){a.push($(this).children().eq(2).text())})),i=0;i<a.length;i++)if(a[i]==t)return showQtip(e,firewall_hint_Trigger_port_same),!1;return!0}function openPortToCss(){($.browser.mozilla||$.browser.opera)&&$("#service_list").css({"table-layout":"fixed","word-break":"break-all","word-wrap":"break-word"})}$(document).ready((function(){initPage(),openPortToCss(),$(".user_options").attr("width","105");var t=null,e=null,a={},i=[];function r(){return a={SATriggerName:$.trim($("#sa_trigger_name").val()),SATriggerStatus:$("#sa_trigger_status option:selected").text(),SATriggerPort:$.trim($("#sa_trigger_port").val()),SATriggerProtocol:$("#sa_trigger_protocol option:selected").text(),SAOpenProtocol:$("#sa_open_protocol option:selected").text(),SAOpenPort:$.trim($("#sa_open_port").val())}}function o(t){return i=t.split(";")}function p(){$.each($(".qtip-defaults"),(function(){$(this).remove()}));var t=$.trim($("#sa_trigger_name").val());if(""==t)return showQtip("sa_trigger_name",common_message_name_empty),!1;if(!checkInputChar(t))return showQtip("sa_trigger_name",firewall_hint_name_valid_type),!1;if(!isVaildSpecialPort($.trim($("#sa_trigger_port").val()),"sa_trigger_port"))return!1;if(!comparePort($.trim($("#sa_trigger_port").val()),"sa_trigger_port"))return!1;var e=o($("#sa_open_port").val());if(e.length>5)return showQtip("sa_open_port",setting_hint_special_applications_port_maximum),!1;var a=!0,r=0;return $(e).each((function(t){if(!isVaildPortForIPFilter(i[t],"sa_open_port"))return a=!1;var e=i[t].split("-");return 2==e.length&&(r=parseInt(e[1],10)-parseInt(e[0],10)+1),r>200?(showQtip("sa_open_port",IDS_Security_open_port_range),a=!1):void 0})),a}function l(){var t=[];$(".user_add_line").each((function(e){var a=[["",""],["",""],["",""],["",""],["",""]],i=o($(this).children().eq(5).text());$.isArray(i)?$(i).each((function(t){i[t].length>=0&&(a[t]=portPartsParse(i[t]))})):a[0]=portPartsParse(i);var r={SpecialApplicationTriggerName:nbspToSpace($(this).children().eq(0).html()),SpecialApplicationTriggerStatus:getDArrayElement(filterStatusArray,$(this).children().eq(1).text(),"key"),SpecialApplicationTriggerPort:$(this).children().eq(2).text(),SpecialApplicationTriggerProtocol:getDArrayElement(protocolStatusArray,$(this).children().eq(3).text(),"key"),SpecialApplicationOpenProtocol:getDArrayElement(protocolStatusArray,$(this).children().eq(4).text(),"key"),SpecialApplicationStartOpenPort0:a[0][0],SpecialApplicationEndOpenPort0:a[0][1],SpecialApplicationStartOpenPort1:a[1][0],SpecialApplicationEndOpenPort1:a[1][1],SpecialApplicationStartOpenPort2:a[2][0],SpecialApplicationEndOpenPort2:a[2][1],SpecialApplicationStartOpenPort3:a[3][0],SpecialApplicationEndOpenPort3:a[3][1],SpecialApplicationStartOpenPort4:a[4][0],SpecialApplicationEndOpenPort4:a[4][1]};t.push(r)}));var e=object2xml("request",{LanPorts:{LanPort:t}});saveAjaxData("api/security/special-applications",e,(function(t){var e=xml2object(t);isAjaxReturnOK(e)?(showInfoDialog(common_success),button_enable("apply","0")):initPage()}))}initSelectOption("sa_trigger_status",filterStatusArray),initSelectOption(["sa_trigger_protocol","sa_open_protocol"],protocolStatusArray),$("#add_item_cancel").live("click",(function(){hideAddItemControl(),1!=add_flag&&1!=ok_flag||button_enable("apply","1")})),$("#add_item").click((function(){isButtonEnable("add_item")&&(showAddItemControl(),$(".add_item_control input").eq(0).focus(),button_enable("apply","0"))})),$(".button_edit_list").live("click",(function(){if($(".add_item_control:hidden").size()>0&&$("#edit_item_ok").size()<1){e=$(".button_edit_list").index(this),t=$(".user_add_line").eq(e).html();var a=$(this).parent().siblings(),i=a.eq(0),r=i.html();r=nbspToSpace(r);var o=a.eq(1),p=a.eq(2),l=a.eq(3),n=a.eq(4),c=a.eq(5),s=o.html(),_=l.html(),S=n.html();i.html('<input type="text" value="'+XSSResolveHtmlReturnChar(r)+'" id="sa_trigger_name" maxlength="30"/></td>'),p.html('<input type="text" value="'+XSSResolveHtmlReturnChar(p.html())+'" id="sa_trigger_port"></td>'),c.html('<input type="text" value="'+XSSResolveHtmlReturnChar(c.html())+'" id="sa_open_port"></td>'),createSelect(o,"sa_trigger_status",filterStatusArray),createSelect(l,"sa_trigger_protocol",protocolStatusArray),createSelect(n,"sa_open_protocol",protocolStatusArray),$("#sa_trigger_status").val(getDArrayElement(filterStatusArray,s,"key")),$("#sa_trigger_status").attr("style","width:70px"),$("#sa_trigger_protocol").val(getDArrayElement(protocolStatusArray,_,"key")),$("#sa_open_protocol").val(getDArrayElement(protocolStatusArray,S,"key")),$(this).parent().html('<a class="clr_blue" id="edit_item_ok" href="javascript:void(0);">'+common_ok+'</a><a class="clr_blue" id="edit_item_cancel" href="javascript:void(0);">'+common_cancel+"</a>"),hideAddItemControl(),$(".user_add_line input").eq(0).focus(),$("#edit_item_cancel").live("click",(function(){$(".user_add_line").eq(e).html(t),$(".qtip").qtip("destroy",!0),isButtonEnable("add_item")||(button_enable("add_item","1"),1!=ok_flag&&1!=add_flag||button_enable("apply","1")),$(".user_add_line").length>=SPECIAL_APP_NUM&&button_enable("add_item","0")})),$("#add_item").live("click",(function(){isButtonEnable("add_item")&&($(".user_add_line").eq(e).html(t),$(".qtip").qtip("destroy",!0))})),button_enable("apply","0"),button_enable("add_item","0")}})),$("#add_item_ok").live("click",(function(){r(),p()&&(hideAddItemControl(),addFilter($("#service_list tr"),spaceToNbsp(XSSResolveCannotParseChar(a.SATriggerName)),a.SATriggerStatus,a.SATriggerPort,a.SATriggerProtocol,a.SAOpenProtocol,a.SAOpenPort),button_enable("apply","1")),$(".user_add_line").length>=SPECIAL_APP_NUM&&button_enable("add_item","0"),add_flag=1})),$("#edit_item_ok").live("click",(function(){if(p()){r(),hideAddItemControl();var i=$(this).parent().siblings();i.eq(0).html(spaceToNbsp(a.SATriggerName)),i.eq(1).html(a.SATriggerStatus),i.eq(2).html(a.SATriggerPort),i.eq(3).html(a.SATriggerProtocol),i.eq(4).html(a.SAOpenProtocol),i.eq(5).html(a.SAOpenPort),$(this).parent().html('<span class="button_edit_list clr_blue">'+common_edit+'</span><span class="button_delete_list clr_blue">'+common_delete+"</span>"),t=$(".user_add_line").eq(e).html(),button_enable("apply","1"),button_enable("add_item","1"),ok_flag=1,$(".user_add_line").length>=SPECIAL_APP_NUM&&button_enable("add_item","0")}})),$("#apply").click((function(){isButtonEnable("apply")&&showConfirmDialog(firewall_hint_submit_list_item,l),ok_flag=0,add_flag=0}))}));

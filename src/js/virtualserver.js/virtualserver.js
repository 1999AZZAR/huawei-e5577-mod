var VIRTUAL_SERVER_NUM=16,ok_flag=0,add_flag=0,protocolStatusArray=[[PROTOCOL_BOTH,firewall_label_tcp_or_udp],[PROTOCOL_TCP,firewall_label_tcp],[PROTOCOL_UDP,firewall_label_udp]],filterStatusArray=[[FILTER_DISABLED,common_off],[FILTER_ENABLED,common_on]];function comparePortAndProtocal(t,e,a){var r=[],l=[];for($(".user_add_line").each((function(t){r.push($(this).children().eq(1).text()),l.push($(this).children().eq(4).text())})),i=0;i<r.length;i++)if(r[i]==t&&l[i]==e)return showQtip(a,ID_hint_virtual_server_has_exist),!1;return!0}function compareWanPort(t,e){var a=[];for($(".user_add_line").each((function(t){a.push($(this).children().eq(1).text())})),i=0;i<a.length;i++)if(a[i]==t)return showQtip(e,ID_hint_virtual_server_has_exist),!1;return!0}function isVaildVirtual(){var t=$.trim($("#input_server_name").val()),e=$.trim($("#input_wan_ip_address").val()),a=$.trim($("#input_lan_port").val()),r=$.trim($("#input_wan_port").val());return $.trim($("#select_protocol_status").find("option:selected").text()),$.each($(".qtip-defaults"),(function(){$(this).remove()})),""==t?(showQtip("input_server_name",common_message_name_empty),!1):checkInputChar(t)?""==r?(showQtip("input_wan_port",firewall_hint_port_empty),!1):!(!isVaildSpecialPort(r,"input_wan_port")||0==compareWanPort(r,"input_wan_port")||(""!=e&&isValidIpAddress(e)&&isSameSubnetAddrs(e,dhcpLanIPAddress,dhcpLanNetmask)&&isBroadcastOrNetworkAddress(e,dhcpLanNetmask)&&e!=dhcpLanIPAddress?""==a?(showQtip("input_lan_port",firewall_hint_port_empty),1):!isVaildSpecialPort(a,"input_lan_port"):(showQtip("input_wan_ip_address",dialup_hint_ip_address_empty),1))):(showQtip("input_server_name",firewall_hint_name_valid_type),!1)}function initPage(){VIRTUAL_SERVER_NUM=parseInt(g_config_firewall.virtualserver.number,10),button_enable("apply","0"),initSelectOption("select_protocol_status",protocolStatusArray),initSelectOption("select_status",filterStatusArray),$("#select_protocol_status").val(PROTOCOL_BOTH),$("#select_status").val(FILTER_DISABLED),$(".user_add_line").remove(),getAjaxData("api/dhcp/settings",(function(t){var e=xml2object(t);"response"==e.type&&(dhcpPageVar=e.response,initDhcp())})),getAjaxData("api/security/virtual-servers",(function(t){var e,a=xml2object(t).response.Servers.Server;a?(a.length>=VIRTUAL_SERVER_NUM&&button_enable("add_item","0"),$.isArray(a)?($(a).each((function(t){addFilter($("#service_list tr"),spaceToNbsp(XSSResolveCannotParseChar(a[t].VirtualServerIPName)),a[t].VirtualServerWanPort,XSSResolveCannotParseChar(a[t].VirtualServerIPAddress),a[t].VirtualServerLanPort,getDArrayElement(protocolStatusArray,a[t].VirtualServerProtocol,"value"),getDArrayElement(filterStatusArray,a[t].VirtualServerStatus,"value"))})),e=a[a.length-1]):(addFilter($("#service_list tr"),spaceToNbsp(XSSResolveCannotParseChar(a.VirtualServerIPName)),a.VirtualServerWanPort,XSSResolveCannotParseChar(a.VirtualServerIPAddress),a.VirtualServerLanPort,getDArrayElement(protocolStatusArray,a.VirtualServerProtocol,"value"),getDArrayElement(filterStatusArray,a.VirtualServerStatus,"value")),e=a),$("#input_server_name").val(e.VirtualServerIPName),$("#input_wan_port").val(e.VirtualServerWanPort),$("#input_wan_ip_address").val(e.VirtualServerIPAddress),$("#input_lan_port").val(e.VirtualServerLanPort)):($("#input_server_name").val(""),$("#input_wan_port").val(""),$("#input_wan_ip_address").val(""),$("#input_lan_port").val(""))}))}function openPortToCss(){($.browser.mozilla||$.browser.opera)&&$("#service_list").css({"table-layout":"fixed","word-break":"break-all","word-wrap":"break-word"})}$(document).ready((function(){initPage(),openPortToCss(),$(".user_options").attr("width","105"),$("#add_item_cancel").live("click",(function(){hideAddItemControl(),1!=add_flag&&1!=ok_flag||button_enable("apply","1")})),$("#add_item").click((function(){isButtonEnable("add_item")&&(showAddItemControl(),$(".add_item_control input").eq(0).focus(),button_enable("apply","0"))})),$("#add_item_ok").live("click",(function(){if(isVaildVirtual()){var t=$.trim($("#input_server_name").val()),e=$.trim($("#input_wan_port").val()),a=$.trim($("#input_wan_ip_address").val()),r=$.trim($("#input_lan_port").val()),i=$("#select_protocol_status option:selected").text(),l=$("#select_status option:selected").text();hideAddItemControl(),addFilter($("#service_list tr"),spaceToNbsp(XSSResolveCannotParseChar(t)),e,XSSResolveCannotParseChar(a),r,i,l),button_enable("apply","1"),$(".user_add_line").length>=VIRTUAL_SERVER_NUM&&button_enable("add_item","0"),add_flag=1}}));var t=null,e=null;function a(){var t=[];$(".user_add_line").each((function(){var e={VirtualServerIPName:nbspToSpace($(this).children().eq(0).html()),VirtualServerStatus:getDArrayElement(filterStatusArray,$(this).children().eq(5).text(),"key"),VirtualServerRemoteIP:"",VirtualServerWanPort:$(this).children().eq(1).text(),VirtualServerWanEndPort:"",VirtualServerLanPort:$(this).children().eq(3).text(),VirtualServerIPAddress:$(this).children().eq(2).text(),VirtualServerProtocol:getDArrayElement(protocolStatusArray,$(this).children().eq(4).text(),"key")};t.push(e)}));var e=object2xml("request",{Servers:{Server:t}});saveAjaxData("api/security/virtual-servers",e,(function(t){var e=xml2object(t);isAjaxReturnOK(e)?(showInfoDialog(common_success),button_enable("apply","0")):(showInfoDialog(common_failed),initPage())}))}$(".button_edit_list").live("click",(function(){if($(".add_item_control:hidden").size()>0&&$("#edit_item_ok").size()<1){e=$(".button_edit_list").index(this),t=$(".user_add_line").eq(e).html();var a=$(this).parent().siblings(),r=a.eq(0),i=r.html();i=nbspToSpace(i);var l=a.eq(1),n=a.eq(2),o=a.eq(3),s=a.eq(4),_=a.eq(5),u=s.html(),d=_.html();r.html('<input type="text" value="'+XSSResolveHtmlReturnChar(i)+'" id="input_server_name"  maxlength="30"/></td>'),l.html('<input type="text" value="'+XSSResolveCannotParseChar(l.html())+'" id="input_wan_port"></td>'),n.html('<input type="text" value="'+XSSResolveCannotParseChar(n.html())+'" id="input_wan_ip_address"></td>'),o.html('<input type="text" value="'+XSSResolveCannotParseChar(o.html())+'" id="input_lan_port"></td>'),createSelect(s,"select_protocol_status",protocolStatusArray),createSelect(_,"select_status",filterStatusArray),$("#select_protocol_status").val(getDArrayElement(protocolStatusArray,u,"key")),$("#select_status").val(getDArrayElement(filterStatusArray,d,"key")),$(this).parent().html('<a class="clr_blue" id="edit_item_ok" href="javascript:void(0);">'+common_ok+'</a><a class="clr_blue" id="edit_item_cancel" href="javascript:void(0);">'+common_cancel+"</a>"),hideAddItemControl(),$(".user_add_line input").eq(0).focus(),$("#edit_item_cancel").live("click",(function(){$(".user_add_line").eq(e).html(t),$(".qtip").qtip("destroy",!0),isButtonEnable("add_item")||(button_enable("add_item","1"),1!=ok_flag&&1!=add_flag||button_enable("apply","1")),$(".user_add_line").length>=VIRTUAL_SERVER_NUM&&button_enable("add_item","0")})),$("#add_item").live("click",(function(){isButtonEnable("add_item")&&($(".user_add_line").eq(e).html(t),$(".qtip").qtip("destroy",!0))})),button_enable("apply","0"),button_enable("add_item","0")}})),$("#edit_item_ok").live("click",(function(){if(isVaildVirtual()){var a=$.trim($("#input_server_name").val()),r=$.trim($("#input_wan_port").val()),i=XSSResolveCannotParseChar($.trim($("#input_wan_ip_address").val())),l=$.trim($("#input_lan_port").val()),n=$("#select_protocol_status option:selected").text(),o=$("#select_status option:selected").text();hideAddItemControl();var s=$(this).parent().siblings();s.eq(0).html(spaceToNbsp(XSSResolveCannotParseChar(a))),s.eq(1).html(XSSResolveCannotParseChar(r)),s.eq(2).html(XSSResolveCannotParseChar(i)),s.eq(3).html(XSSResolveCannotParseChar(l)),s.eq(4).html(n),s.eq(5).html(o),$(this).parent().html('<span class="button_edit_list clr_blue">'+common_edit+'</span><span class="button_delete_list clr_blue">'+common_delete+"</span>"),t=$(".user_add_line").eq(e).html(),button_enable("apply","1"),button_enable("add_item","1"),ok_flag=1,$(".user_add_line").length>=VIRTUAL_SERVER_NUM&&button_enable("add_item","0")}})),$("#apply").click((function(){isButtonEnable("apply")&&showConfirmDialog(firewall_hint_submit_list_item,a),ok_flag=0,add_flag=0}))}));

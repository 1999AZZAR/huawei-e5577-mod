var LAN_IP_FILTER_NUM=16,ok_flag=0,add_flag=0,protocolStatusArray=[[PROTOCOL_BOTH,firewall_label_tcp_or_udp],[PROTOCOL_TCP,firewall_label_tcp],[PROTOCOL_UDP,firewall_label_udp],[PROTOCOL_IMCP,firewall_label_imcp]],filterStatusArray=[[FILTER_DISABLED,common_off],[FILTER_ENABLED,common_on]],g_source_num=0,firewall_status=null;function addLanipFilter(t){var e=null,a=1;for(e='<tr class="user_add_line">',a=1;a<arguments.length;a++)e+="<td>"+arguments[a]+"</td>";e+="<td class='user_options clr_blue_hover' width='105'><span class=\"button_edit_list clr_blue\">"+common_edit+'</span><span class="button_delete_list clr_blue">'+common_delete+"</span></td></tr>";var l=$(t).size();$(t).eq(l-2).after(e)}function ipTranApply(t){var e=[],a="",l=0;if(null==t||null==t||""==t)return"";if(4!=(e=t.split(".")).length)return"";for(l=3;l>=0&&"*"==e[l];l--)e[l]="0";return a=a.concat(e[0],".",e[1],".",e[2],".",e[3])}function ipTranGet(t,e){var a=[],l="",i=0;if(null==t||null==t||""==t)return"";if(4!=(a=t.split(".")).length)return"";for(i=3;i>-1&&"0"==a[i]&&e>0;i--)a[i]="*",e--;return l=l.concat(a[0],".",a[1],".",a[2],".",a[3])}function ipGetMaskNum(t){var e,a=0,l=0;if(null==t||null==t||""==t)return"";if(4!=(e=t.split(".")).length)return"";for(a=3;a>-1&&"*"==e[a];a--)l++;return l}function sourceIpTranApplyValid(t){var e=[],a="",l=0;if(null==t||null==t||""==t)return"";if(4!=(e=t.split(".")).length)return"";for(l=3;l>-1&&"*"==e[l];l--)e[l]="0";return a=a.concat(e[0],".",e[1],".",e[2],".",e[3])}function isValidIpAddressForIPFilter(t){var e=t.split(".");if(4!=e.length)return!1;for(i=0;i<4;i++){if("*"==e[i]&&3!=i&&"*"!=e[i+1])return!1;if(1==isNaN(e[i])&&"*"!=e[i])return!1;if(""==e[i])return!1;if(-1!=e[i].indexOf(" "))return!1;if(0==e[i].indexOf("0")&&1!=e[i].length)return!1}return!(e[0]<=0||127==e[0]||e[0]>223||e[1]<0||e[1]>255||e[2]<0||e[2]>255||e[3]<0||e[3]>=255)}function checkIpPort(t,e){return""==t?(showQtip(e,firewall_hint_port_empty),!1):!!isVaildPortForIPFilter(t,e)}function isVaildValue(){$.each($(".qtip-defaults"),(function(){$(this).remove()}));var t=$.trim($("#input_lan_ip_address").val()),e=$.trim($("#input_lan_ip_port").val()),a=$.trim($("#input_wan_ip_address").val()),l=$.trim($("#input_wan_ip_port").val());if("0"!=g_config_firewall.lanipfilter.lan_enable){if(""==t||!isValidIpAddressForIPFilter(t)||t==dhcpLanIPAddress||!isSameSubnetAddrs(sourceIpTranApplyValid(t),dhcpLanIPAddress,dhcpLanNetmask))return showQtip("input_lan_ip_address",dialup_hint_ip_address_empty),!1;if(1!=$("#select_protocol_status").val()&&!checkIpPort(e,"input_lan_ip_port"))return!1}if("0"!=g_config_firewall.lanipfilter.wan){if(""==a||!isValidIpAddressForIPFilter(a))return showQtip("input_wan_ip_address",dialup_hint_ip_address_empty),!1;if(isSameSubnetAddrs(t,a,subnetMask))return showQtip("input_wan_ip_address",IDS_dialup_hint_wan_ip_address),!1;if(1!=$("#select_protocol_status").val()&&!checkIpPort(l,"input_wan_ip_port"))return!1}return!0}function initPage(){button_enable("apply","0"),$(".user_add_line").remove(),getAjaxData("api/security/firewall-switch",(function(t){var e=xml2object(t);"response"==e.type&&(firewall_status=e.response)}),{sync:!0}),getAjaxData("api/dhcp/settings",(function(t){var e=xml2object(t);"response"==e.type&&(dhcpPageVar=e.response,initDhcp())})),getAjaxData("api/security/lan-ip-filter",(function(t){var e,a,l,i,r,n=xml2object(t).response.IPFilters.IPFilter;if(n?(n.length>=LAN_IP_FILTER_NUM&&button_enable("add_item","0"),$.isArray(n)?($(n).each((function(t){e=portJoin(n[t].LanIPFilterLanStartPort,n[t].LanIPFilterLanEndPort),a=portJoin(n[t].LanIPFilterWanStartPort,n[t].LanIPFilterWanEndPort),"0"==e&&"0"==a&&(e="",a=""),l=getDArrayElement(protocolStatusArray,n[t].LanIPFilterProtocol,"value"),i=getDArrayElement(filterStatusArray,n[t].LanIPFilterStatus,"value"),"0"==g_config_firewall.lanipfilter.wan?addLanipFilter($("#service_list tr"),ipTranGet(XSSResolveCannotParseChar(n[t].LanIPFilterLanStartAddress),n[t].LanIPFilterSrcStartIPMask),e,l,i):"0"==g_config_firewall.lanipfilter.lan_enable?addLanipFilter($("#service_list tr"),ipTranGet(XSSResolveCannotParseChar(n[t].LanIPFilterWanStartAddress),n[t].LanIPFilterDestStartIPMask),a,l,i):addLanipFilter($("#service_list tr"),ipTranGet(XSSResolveCannotParseChar(n[t].LanIPFilterLanStartAddress),n[t].LanIPFilterSrcStartIPMask),e,ipTranGet(XSSResolveCannotParseChar(n[t].LanIPFilterWanStartAddress),n[t].LanIPFilterDestStartIPMask),a,l,i)})),r=n[n.length-1]):(e=portJoin(n.LanIPFilterLanStartPort,n.LanIPFilterLanEndPort),a=portJoin(n.LanIPFilterWanStartPort,n.LanIPFilterWanEndPort),"0"==e&&"0"==a&&(e="",a=""),l=getDArrayElement(protocolStatusArray,n.LanIPFilterProtocol,"value"),i=getDArrayElement(filterStatusArray,n.LanIPFilterStatus,"value"),"0"==g_config_firewall.lanipfilter.wan?addLanipFilter($("#service_list tr"),ipTranGet(XSSResolveCannotParseChar(n.LanIPFilterLanStartAddress),n.LanIPFilterSrcStartIPMask),e,l,i):"0"==g_config_firewall.lanipfilter.lan_enable?addLanipFilter($("#service_list tr"),ipTranGet(XSSResolveCannotParseChar(n.LanIPFilterWanStartAddress),n.LanIPFilterDestStartIPMask),a,l,i):addLanipFilter($("#service_list tr"),ipTranGet(XSSResolveCannotParseChar(n.LanIPFilterLanStartAddress),n.LanIPFilterSrcStartIPMask),e,ipTranGet(XSSResolveCannotParseChar(n.LanIPFilterWanStartAddress),n.LanIPFilterDestStartIPMask),a,l,i),r=n),$("#input_lan_ip_address").val(r.LanIPFilterLanStartAddress),$("#input_lan_ip_port").val(e),$("#input_wan_ip_address").val(r.LanIPFilterWanStartAddress),$("#input_wan_ip_port").val(a)):($("#input_lan_ip_address").val(""),$("#input_lan_ip_port").val(""),$("#input_wan_ip_address").val(""),$("#input_wan_ip_port").val("")),null!=firewall_status&&0==firewall_status.FirewallMainSwitch)return button_enable("add_item","0"),$("#service_list").attr("disabled",!0),$(".button_edit_list").removeClass("clr_blue").addClass("clr_gray"),$(".button_delete_list").removeClass("clr_blue").addClass("clr_gray"),showInfoDialog(IDS_security_message_firewall_disabled),!1;null!=firewall_status&&0==firewall_status.FirewallIPFilterSwitch&&(button_enable("add_item","0"),$("#service_list").attr("disabled",!0),$(".button_edit_list").removeClass("clr_blue").addClass("clr_gray"),$(".button_delete_list").removeClass("clr_blue").addClass("clr_gray"),showInfoDialog(IDS_security_message_ip_address_disabled))}))}function lanIPFilter_getConfig(){LAN_IP_FILTER_NUM=parseInt(g_config_firewall.lanipfilter.number,10),"0"==g_config_firewall.lanipfilter.wan?$(".wan_th").hide():$(".wan_th").show(),"0"==g_config_firewall.lanipfilter.lan_enable?$(".lan_th").hide():$(".lan_th").show(),"0"==g_config_firewall.lanipfilter.protocol_imcp&&(protocolStatusArray=[[PROTOCOL_BOTH,firewall_label_tcp_or_udp],[PROTOCOL_TCP,firewall_label_tcp],[PROTOCOL_UDP,firewall_label_udp]])}function checkBeforPostData(){var t=!0;return $(".user_add_line").each((function(e){""==("0"!=g_config_firewall.lanipfilter.lan_enable?ipTranApply($(this).children().eq(2).text()):ipTranApply($(this).children().eq(0).text()))&&(showInfoDialog(dialup_hint_ip_address_empty),t=!1)})),t}var subnetMask=null;function lanIPFilter_getNetmask(){getAjaxData("api/dhcp/settings",(function(t){var e=xml2object(t);"response"==e.type&&(subnetMask=e.response.DhcpLanNetmask)}))}$(document).ready((function(){lanIPFilter_getNetmask(),lanIPFilter_getConfig(),initPage(),$(".user_options").attr("width","105");var t=null,e=null,a=null,l=null,i=null,r=null;function n(){var t=[];$(".user_add_line").each((function(e){var a="",l=["",""],i="",r="",n="",_="",s=getDArrayElement(protocolStatusArray,$(this).children().eq(4).text(),"key"),o=getDArrayElement(filterStatusArray,$(this).children().eq(5).text(),"key");"0"==g_config_firewall.lanipfilter.lan_enable?(a=portPartsParse("1-65535"),i="0.0.0.0",n="4",l=portPartsParse($(this).children().eq(1).text()),r=ipTranApply($(this).children().eq(0).text()),_=ipGetMaskNum($(this).children().eq(0).text()),s=getDArrayElement(protocolStatusArray,$(this).children().eq(2).text(),"key"),o=getDArrayElement(filterStatusArray,$(this).children().eq(3).text(),"key")):(i=ipTranApply($(this).children().eq(0).text()),n=ipGetMaskNum($(this).children().eq(0).text()),a=portPartsParse($(this).children().eq(1).text()),"1"==g_config_firewall.lanipfilter.wan?(r=ipTranApply($(this).children().eq(2).text()),_=ipGetMaskNum($(this).children().eq(2).text()),l=portPartsParse($(this).children().eq(3).text()),s=getDArrayElement(protocolStatusArray,$(this).children().eq(4).text(),"key"),o=getDArrayElement(filterStatusArray,$(this).children().eq(5).text(),"key")):(s=getDArrayElement(protocolStatusArray,$(this).children().eq(2).text(),"key"),o=getDArrayElement(filterStatusArray,$(this).children().eq(3).text(),"key")));var d={LanIPFilterProtocol:s,LanIPFilterStatus:o,LanIPFilterLanStartAddress:i,LanIPFilterLanEndAddress:"",LanIPFilterLanStartPort:a[0],LanIPFilterLanEndPort:a[1],LanIPFilterWanStartAddress:r,LanIPFilterWanEndAddress:"",LanIPFilterWanStartPort:l[0],LanIPFilterWanEndPort:l[1],LanIPFilterSrcStartIPMask:n,LanIPFilterDestStartIPMask:_,LanIPFilterPolicy:"0"};t.push(d)}));var e=object2xml("request",{IPFilters:{IPFilter:t}});saveAjaxData("api/security/lan-ip-filter",e,(function(t){var e=xml2object(t);isAjaxReturnOK(e)?(showInfoDialog(common_success),button_enable("apply","0")):initPage()}))}$(".button_edit_list").live("click",(function(){if($(".add_item_control:hidden").size()>0&&$("#edit_item_ok").size()<1&&null!=firewall_status&&1==firewall_status.FirewallMainSwitch&&null!=firewall_status&&1==firewall_status.FirewallIPFilterSwitch){e=$(".button_edit_list").index(this),t=$(".user_add_line").eq(e).html();var n=$(this).parent().siblings();if("0"!=g_config_firewall.lanipfilter.lan_enable){var _=n.eq(0),s=n.eq(1);"0"!=g_config_firewall.lanipfilter.wan?(a=n.eq(2),l=n.eq(3),i=n.eq(4),r=n.eq(5)):(i=n.eq(2),r=n.eq(3))}else a=n.eq(0),l=n.eq(1),i=n.eq(2),r=n.eq(3);var o=i.html(),d=r.html();"0"!=g_config_firewall.lanipfilter.lan_enable&&(_.html('<input type="text" value="'+XSSResolveHtmlReturnChar(_.html())+'" id="input_lan_ip_address"></td>'),s.html('<input type="text" value="'+XSSResolveHtmlReturnChar(s.html())+'" id="input_lan_ip_port"></td>')),"0"!=g_config_firewall.lanipfilter.wan&&(a.html('<input type="text" value="'+XSSResolveHtmlReturnChar(a.html())+'" id="input_wan_ip_address"></td>'),l.html('<input type="text" value="'+XSSResolveHtmlReturnChar(l.html())+'" id="input_wan_ip_port"></td>')),createSelect(i,"select_protocol_status",protocolStatusArray),createSelect(r,"select_status",filterStatusArray),$("#select_protocol_status").val(getDArrayElement(protocolStatusArray,o,"key")),$("#select_status").val(getDArrayElement(filterStatusArray,d,"key")),$(this).parent().html('<a class="clr_blue" id="edit_item_ok" href="javascript:void(0);">'+common_ok+'</a><a class="clr_blue" id="edit_item_cancel" href="javascript:void(0);">'+common_cancel+"</a>"),hideAddItemControl(),$(".user_add_line input").eq(0).focus(),1==$("#select_protocol_status").val()&&($("#input_lan_ip_port").val(""),$("#input_wan_ip_port").val(""),$("#input_lan_ip_port").attr("disabled","disabled"),$("#input_wan_ip_port").attr("disabled","disabled")),$("#select_protocol_status").change((function(){1==$("#select_protocol_status").val()?($("#input_lan_ip_port").val(""),$("#input_wan_ip_port").val(""),$("#input_lan_ip_port").attr("disabled","disabled"),$("#input_wan_ip_port").attr("disabled","disabled")):($("#input_lan_ip_port").removeAttr("disabled"),$("#input_wan_ip_port").removeAttr("disabled"))})),$("#edit_item_cancel").live("click",(function(){$(".user_add_line").eq(e).html(t),$(".qtip").qtip("destroy",!0),isButtonEnable("add_item")||(button_enable("add_item","1"),1!=ok_flag&&1!=add_flag||button_enable("apply","1")),$(".user_add_line").length>=LAN_IP_FILTER_NUM&&button_enable("add_item","0")})),$("#add_item").live("click",(function(){isButtonEnable("add_item")&&($(".user_add_line").eq(e).html(t),$(".qtip").qtip("destroy",!0))})),button_enable("apply","0"),button_enable("add_item","0")}})),$("#edit_item_ok").live("click",(function(){if(isVaildValue()){var a=$.trim($("#input_lan_ip_address").val()),l=$.trim($("#input_lan_ip_port").val()),i=$.trim($("#input_wan_ip_address").val()),r=$.trim($("#input_wan_ip_port").val()),n=$("#select_protocol_status option:selected").text(),_=$("#select_status option:selected").text();hideAddItemControl();var s=$(this).parent().siblings();"0"!=g_config_firewall.lanipfilter.lan_enable?(s.eq(0).html(a),s.eq(1).html(l),"0"!=g_config_firewall.lanipfilter.wan?(s.eq(2).html(i),s.eq(3).html(r),s.eq(4).html(n),s.eq(5).html(_)):(s.eq(2).html(n),s.eq(3).html(_))):(s.eq(0).html(i),s.eq(1).html(r),s.eq(2).html(n),s.eq(3).html(_)),$(this).parent().html('<span class="button_edit_list clr_blue">'+common_edit+'</span><span class="button_delete_list clr_blue">'+common_delete+"</span>"),t=$(".user_add_line").eq(e).html(),button_enable("apply","1"),button_enable("add_item","1"),ok_flag=1,$(".user_add_line").length>=LAN_IP_FILTER_NUM&&button_enable("add_item","0")}})),$("#add_item_ok").live("click",(function(){if(isVaildValue()){var t=$.trim($("#input_lan_ip_address").val()),e=$.trim($("#input_lan_ip_port").val()),a=$.trim($("#input_wan_ip_address").val()),l=$.trim($("#input_wan_ip_port").val()),i=$("#select_protocol_status option:selected").text(),r=$("#select_status option:selected").text();t=XSSResolveCannotParseChar(t),a=XSSResolveCannotParseChar(a),hideAddItemControl(),"0"==g_config_firewall.lanipfilter.wan?addLanipFilter($("#service_list tr"),t,e,i,r):"0"==g_config_firewall.lanipfilter.lan_enable?addLanipFilter($("#service_list tr"),a,l,i,r):addLanipFilter($("#service_list tr"),t,e,a,l,i,r),button_enable("apply","1"),$(".user_add_line").length>=LAN_IP_FILTER_NUM&&button_enable("add_item","0"),add_flag=1}return!1})),$("#add_item_cancel").live("click",(function(){return hideAddItemControl(),1!=add_flag&&1!=ok_flag||button_enable("apply","1"),!1})),$("#add_item").click((function(){isButtonEnable("add_item")&&(showAddItemControl(),$(".add_item_control input").eq(0).focus(),button_enable("apply","0"),$("#input_lan_ip_address").removeAttr("disabled"),$("#input_lan_ip_port").removeAttr("disabled"),$("#input_wan_ip_address").removeAttr("disabled"),$("#input_wan_ip_port").removeAttr("disabled"),1==$("#select_protocol_status").val()&&($("#input_lan_ip_port").attr("disabled","disabled"),$("#input_wan_ip_port").attr("disabled","disabled")))})),$(".button_delete_list").live("click",(function(){if($(".add_item_control:hidden").size()>0&&$("#edit_item_ok").size()<1&&null!=firewall_status&&1==firewall_status.FirewallMainSwitch&&null!=firewall_status&&1==firewall_status.FirewallIPFilterSwitch){var t=$(".button_delete_list").index(this);call_dialog(common_delete,firewall_hint_delete_list_item,common_ok,"pop_OK",common_cancel,"pop_Cancel"),$("#pop_OK").click((function(){deleteFilter(t,$(".user_add_line")),clearDialog_table(),button_enable("apply","1"),button_enable("add_item","1")}))}})),$("#apply").click((function(){isButtonEnable("apply")&&("1"==g_config_firewall.lanipfilter.wan?checkBeforPostData()?showConfirmDialog(firewall_hint_submit_list_item,n):button_enable("apply","0"):showConfirmDialog(firewall_hint_submit_list_item,n)),ok_flag=0,add_flag=0})),initSelectOption("select_protocol_status",protocolStatusArray),initSelectOption("select_status",filterStatusArray),$("#select_protocol_status").change((function(){1==$("#select_protocol_status").val()?($("#input_lan_ip_port").val(""),$("#input_wan_ip_port").val(""),$("#input_lan_ip_port").attr("disabled","disabled"),$("#input_wan_ip_port").attr("disabled","disabled")):($("#input_lan_ip_port").removeAttr("disabled"),$("#input_wan_ip_port").removeAttr("disabled"))}))}));

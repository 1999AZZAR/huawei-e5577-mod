var USSD_RETURN_RESULT=2001,USSD_OUT_TIME=2003,USSD_HAVE_USSD_DIALOG=1,USSD_HAVE_NOT_USSD_DIALOG=0,g_ussd_preconfig="",g_ussd_postconfig="",g_ussd_btnStr="",g_ussd_currentFun=null,g_ussd_chargeLimitText="*0123456789#",g_ussd_generalLimitText="*0123456789#",g_ussd_generalCommandList=[],g_ussd_timeout=!1,g_ussd_timer_maxDialog=null,balance_html="",general_html="",g_ussd_sms_number="",g_ussd_send_type="",g_ussd_status_timer="",g_ussd_muilvalue_timeout="",MACRO_USSD_TIMER=12e4,g_ussd_timer_muilvale=null,g_ussd_dialogstatus_finished=!0,g_multi_config_list=null,vsim_status=0;function ussd_initVar(){getConfigData("config/ussd/prepaidussd.xml",(function(e){var s=xml2object(e);"config"==s.type&&(g_ussd_preconfig=s.config.USSD)}),{sync:!0}),getConfigData("config/ussd/postpaidussd.xml",(function(e){var s=xml2object(e);"config"==s.type&&(g_ussd_postconfig=s.config.USSD)}),{sync:!0})}function ussd_show_ActivateInternetService(e){$(".ussd_content > div").hide(),$("#cur_ussd_type").text(ussd_label_ActivateInternetService_title),ussd_getDialogStatus(),ussd_activateInternetService(e),$("#fun_activateInternetService").show(),chang_menuli()}function ussd_show_BalanceInquiry(e){$(".ussd_content > div").hide(),$("#cur_ussd_type").text(ussd_label_BalanceInquiry_title),ussd_getDialogStatus(),$("#fun_balanceInquiry > *").remove(),ussd_balanceInquiry(e),$("#fun_balanceInquiry").show(),chang_menuli()}function ussd_show_Charge(e){$(".ussd_content > div").hide(),$("#cur_ussd_type").text(ussd_label_Charge_title),ussd_getDialogStatus(),$("#fun_charge > *").remove(),ussd_charge(e),$("#fun_charge").show(),chang_menuli()}function ussd_show_General(e){$(".ussd_content > div").hide(),$("#cur_ussd_type").text(ussd_label_Universal_title),ussd_getDialogStatus(),general_html="",$("#general_result_table").html(general_html),g_ussd_generalCommandList.length=0,ussd_general(e),$("#fun_general").show(),$("#general_command_select_input").focus(),chang_menuli()}function ussd_initShow(){switch(g_ussdLeftmenu[0]){case"preactivate_internet_service":ussd_show_ActivateInternetService(g_ussd_preconfig.ActivateInternetService);break;case"prebalanceInquiry":ussd_show_BalanceInquiry(g_ussd_preconfig.BalanceInquiry);break;case"precharge":ussd_show_Charge(g_ussd_preconfig.Charge);break;case"pregeneral":ussd_show_General(g_ussd_preconfig.General);break;case"postactivate_internet_service":ussd_show_ActivateInternetService(g_ussd_postconfig.ActivateInternetService);break;case"postbalanceInquiry":ussd_show_BalanceInquiry(g_ussd_postconfig.BalanceInquiry);break;case"postcharge":ussd_show_Charge(g_ussd_postconfig.Charge);break;case"postgeneral":ussd_show_General(g_ussd_postconfig.General)}}function ussd_initPreClick(){$("#pre_service_title").live("click",(function(){$("#ussd_setting_menu li").removeClass("subClick"),$("#pre_service_title").addClass("subClick"),ussd_show_ActivateInternetService(g_ussd_preconfig.ActivateInternetService)})),$("#pre_fun_balanceInquiry").live("click",(function(){$("#ussd_setting_menu li").removeClass("subClick"),$("#pre_fun_balanceInquiry").addClass("subClick"),ussd_show_BalanceInquiry(g_ussd_preconfig.BalanceInquiry)})),$("#pre_fun_charge").live("click",(function(){$("#ussd_setting_menu li").removeClass("subClick"),$("#pre_fun_charge").addClass("subClick"),clearAllErrorLabel(),ussd_show_Charge(g_ussd_preconfig.Charge)})),$("#pre_fun_general").live("click",(function(){$("#ussd_setting_menu li").removeClass("subClick"),$("#pre_fun_general").addClass("subClick"),clearAllErrorLabel(),ussd_show_General(g_ussd_preconfig.General)}))}function ussd_initPostClick(){$("#post_service_title").live("click",(function(){$("#ussd_setting_menu li").removeClass("subClick"),$("#post_service_title").addClass("subClick"),ussd_show_ActivateInternetService(g_ussd_postconfig.ActivateInternetService)})),$("#post_fun_balanceInquiry").live("click",(function(){$("#ussd_setting_menu li").removeClass("subClick"),$("#post_fun_balanceInquiry").addClass("subClick"),ussd_show_BalanceInquiry(g_ussd_postconfig.BalanceInquiry)})),$("#post_fun_charge").live("click",(function(){$("#ussd_setting_menu li").removeClass("subClick"),$("#post_fun_charge").addClass("subClick"),clearAllErrorLabel(),ussd_show_Charge(g_ussd_postconfig.Charge)})),$("#post_fun_general").live("click",(function(){$("#ussd_setting_menu li").removeClass("subClick"),$("#post_fun_general").addClass("subClick"),clearAllErrorLabel(),ussd_show_General(g_ussd_postconfig.General)}))}function ussd_sms_multi_init(e){e=parseInt(e,10),g_ussd_send_type="",g_ussd_sms_number="",g_ussd_muilvalue_timeout="0",$.each(g_multi_config_list,(function(s,t){e==s&&(void 0!==t.Type?(g_ussd_send_type=t.Type.toLocaleLowerCase(),g_ussd_sms_number=t.Number):(g_ussd_send_type="",g_ussd_sms_number=""),g_ussd_muilvalue_timeout=void 0!==t.timeout?t.timeout:"0")}))}function ussd_activateInternetService(value){var config_list=[];if(value.Items&&value.Items.Item&&($.isArray(value.Items.Item)?config_list=value.Items.Item:config_list.push(value.Items.Item)),0!=config_list.length){g_multi_config_list=config_list,$("#activate_internet_service_description").html(regURL(eval(value.Description)));var subTr="",selectHtml="";selectHtml="<select id='activate_internet_service_select'>",$.each(config_list,(function(n,value){selectHtml+="<option value='"+$.trim(value.Command)+"'>"+eval(value.Subject).replace("%d","1")+"</option>"})),selectHtml+="</select>";var btnHTML="";btnHTML=create_button_html(eval(config_list[0].Action),"ActivateInternetServiceBtn","ActivateInternetServiceBtn"),subTr+="<tr><td height='36'><label>"+selectHtml+"<label></td>",subTr+='<td class="align_right">'+btnHTML+"</td></tr>",$("#activate_internet_service table").html(subTr),ieRadiusBorder(),"material"==webui_mode&&materializeButtons(),$("#ActivateInternetServiceBtn").bind("click",(function(){ussd_sendCommand("ActivateInternetService",$("#activate_internet_service_select").val(),"CodeType")}))}}function ussd_balanceInquiry(value){var config_list=[];$.isArray(value.Items.Item)?config_list=value.Items.Item:config_list.push(value.Items.Item),0!=config_list.length&&(g_multi_config_list=config_list,$.each(config_list,(function(n,value){var balance_html="<div class='ussd_extend_border'><p><label id=balance_inquiry_description"+n+"></label></p>";balance_html+=' <div class="ussd_concent"> ',balance_html+=' <div class="ussd_left_concent" >',balance_html+=" <label id=balance_inquiry_result"+n+"></label></div>",balance_html+=' <div class="ussd_right_concent" id=balance_inquiry_action'+n+"></div> ",balance_html+=' </div><div style="clear:both;float:none"></div></div>',$("#fun_balanceInquiry").append(balance_html);var funName="BalanceInquiry"+n,descriptionId="#balance_inquiry_description"+n,funId="#BalanceInquiry"+n,actionId="#balance_inquiry_action"+n;$(descriptionId).text(eval(value.Description)),ussd_creatBtn(funName,$.trim(value.Command),value.Action,funId),$(actionId).html(g_ussd_btnStr),ieRadiusBorder(),"material"==webui_mode&&materializeButtons()})))}function ussd_charge(value){var config_list=[];$.isArray(value.Items.Item)?config_list=value.Items.Item:config_list.push(value.Items.Item),0!=config_list.length&&(g_multi_config_list=config_list,$.each(config_list,(function(n,value){var charge_html="<div class='ussd_extend_border'><p><label id=charge_description"+n+"></label></p>";charge_html+=' <table cellpadding="0" cellspacing="0" border="0" width="500"> ',charge_html+=" <tr><td>",charge_html+=' <input type="text" id=charge_command'+n+' maxlength="40" class="charge_command_style"/>',charge_html+=' </td><td height="40" class="align_right" id=charge_action'+n+"></td>",charge_html+=' </tr><tr><td colspan="2">',charge_html+='<input type="hidden" id=charge_hint'+n+" /></td> ",charge_html+="</tr></table></div>",$("#fun_charge").append(charge_html);var funName="Charge"+n,descriptionId="#charge_description"+n,funId="#Charge"+n,actionId="#charge_action"+n,commandId="#charge_command"+n;$(descriptionId).text(eval(value.Description)),$(commandId).val(value.Command),ussd_creatBtn(funName,$.trim(value.Command),value.Action,funId,value.LimitText),$(actionId).html(g_ussd_btnStr),ieRadiusBorder(),"material"==webui_mode&&materializeButtons()})))}function ussd_general(value){g_ussd_send_type="",g_ussd_sms_number="",g_ussd_muilvalue_timeout="0",$("#general_title").text(eval(value.Title)),$("#general_description").text(eval(value.Description)),g_ussd_generalLimitText=$.trim(value.LimitText),insertGeneralCommandList(),ussd_creatBtn("General",value.Command,value.Action,"general_btn"),$("#general_action").html(g_ussd_btnStr),ieRadiusBorder(),"material"==webui_mode&&materializeButtons()}function ussd_creatBtn(funName,content,action,btnId,LimitText){g_ussd_btnStr="<span class='button_wrapper ' id='span_"+btnId+"' onclick = \"javascript:ussd_sendCommand('"+funName+"','"+content+"','CodeType', '"+LimitText+"');return false;\">",g_ussd_btnStr+="<input id='"+btnId+"'  class='button_dialog' type='button' value='"+eval(action)+"' /></span>"}function ussd_checkChargeCommand(e,s,t){if(""!=s)try{if(new RegExp(s).exec(e)!=e)return showErrorUnderTextbox("charge_hint"+t,ussd_label_hint_wrong_command,"charge_error_msgId_"+t),$("#charge_command").focus().select(),$(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("button_dialog"),!1}catch(e){return showErrorUnderTextbox("charge_hint"+t,ussd_label_hint_wrong_command,"charge_error_msgId_"+t),$("#charge_command").focus().select(),$(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("button_dialog"),!1}return!0}function ussd_checkGeneralCommand(e){if(""!=g_ussd_generalLimitText)try{if(new RegExp(g_ussd_generalLimitText).exec(e)!=e)return showErrorUnderTextbox("general_hint",ussd_label_hint_wrong_command),$("#general_command_select").select(),$(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("button_dialog"),!1}catch(e){return showErrorUnderTextbox("general_hint",ussd_label_hint_wrong_command),$("#general_command_select").select(),$(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("button_dialog"),!1}return!0}function resolveXMLEntityReference(e){return e.replace(/(\<|\>|\&|\'|\")/g,(function(e,s){return{"<":"&lt;",">":"&gt;","&":"&amp;","'":"&#39;",'"':"&quot;"}[s]}))}function sendCommonBySms(e,s){clearInterval(g_ussd_status_timer);var t=resolveXMLEntityReference(e),n=(new Date).Format("yyyy-MM-dd hh:mm:ss"),a={Index:-1,Phones:{Phone:g_ussd_sms_number},Sca:"",Content:t,Length:t.length,Reserved:0,Date:n,SendType:1},_=object2xml("request",a);saveAjaxData("api/sms/send-sms",_),showInfoDialog(ussd_info_dialog_to_sms),g_ussd_status_timer=setInterval((function(){ussd_getDialogStatus()}),g_feature.update_interval)}function ussdDialogStatusFinished(){closeWaitingDialog(),g_ussd_currentFun=null,g_ussd_dialogstatus_finished=!0}function ussdTimeOutByGetResult(){g_ussd_timeout=!1,g_ussd_timer_maxDialog=setTimeout((function(){g_ussd_timeout=!0,ussdDialogStatusFinished(),showInfoDialog(common_timeout),ussd_releaseUssdDialog()}),MACRO_USSD_TIMER)}function sendCommonByUssd(e,s){"0"==g_ussd_muilvalue_timeout&&(g_ussd_muilvalue_timeout="");var t=object2xml("request",{content:e,codeType:s,timeout:g_ussd_muilvalue_timeout});function n(){ussdDialogStatusFinished(),$(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("button_dialog"),showInfoDialog(common_failed),startLogoutTimer()}showWaitingDialog(common_waiting,IDS_ussd_label_wait_response),g_ussd_dialogstatus_finished=!1,$("#wait_dialog_btn").show().bind("click",(function(){g_ussd_timeout=!0,clearTimeout(g_ussd_timer_maxDialog),clearTimeout(g_ussd_timer_muilvale),ussd_releaseUssdDialog(),g_ussd_dialogstatus_finished=!0,g_ussd_currentFun=null})),saveAjaxData("api/ussd/send",t,(function(e){var s=xml2object(e);"response"==s.type?isAjaxReturnOK(s)?(""!=g_ussd_muilvalue_timeout&&(g_ussd_muilvalue_timeout=parseInt(g_ussd_muilvalue_timeout,10)),g_ussd_muilvalue_timeout>0?g_ussd_timer_muilvale=setTimeout((function(){ussdTimeOutByGetResult(),ussd_getResult()}),1e3*g_ussd_muilvalue_timeout):(ussdTimeOutByGetResult(),ussd_getResult()),startLogoutTimer()):n():"111022"==s.error.code?(closeWaitingDialog(),g_ussd_dialogstatus_finished=!0,showInfoDialog(IDS_security_pin_code_management)):n()}),{errorCB:function(e,s){n()}})}function ussd_sendCommand(e,s,t,n){if(!$(".button_wrapper input").hasClass("disable_btn")){$(".button_wrapper input").removeClass("button_dialog"),$(".button_wrapper input").addClass("disable_btn"),cancelLogoutTimer();var a=0,_="";if("General"==e){if(clearAllErrorLabel(),a=s=$.trim($("#general_command_select").sVal()),null==s||""==s)return showErrorUnderTextbox("general_hint",ussd_label_hint_wrong_command),$("#general_command_select").select(),$(".button_wrapper input").removeClass("disable_btn"),void $(".button_wrapper input").addClass("button_dialog");if(0==ussd_checkGeneralCommand(s))return;g_ussd_currentFun=e,s=XSSResolveCannotParseChar(s),$("#general_command_select").sVal(null),general_html+="<tr><td class='general_status'>"+common_sent+common_colon,general_html+="</td><td><div class='general_content'>"+s+"</div></td></tr>",$("#general_result_table").html(general_html);var i=$("#general_result_table tr:last").height(),l=$("#general_result_table").height();$("#general_result").scrollTop(l-i)}else if("ActivateInternetService"==e){if(clearAllErrorLabel(),a=s,g_ussd_currentFun=e,ussd_sms_multi_init(document.getElementById("activate_internet_service_select").selectedIndex),null==a||""==a)return showErrorUnderTextbox("activate_internet_service_select",ussd_label_hint_wrong_command),$(".button_wrapper input").removeClass("disable_btn"),void $(".button_wrapper input").addClass("button_dialog")}else if(e.indexOf("BalanceInquiry")>-1){if(a=s,g_ussd_currentFun=e,ussd_sms_multi_init(_=e.substring("BalanceInquiry".length)),null==a||""==a)return showErrorUnderTextbox("balance_inquiry_description"+_,ussd_label_hint_wrong_command,"balance_error_msgId_"+_),$(".button_wrapper input").removeClass("disable_btn"),void $(".button_wrapper input").addClass("button_dialog");$("#balance_error_msgId_"+_).parent().remove()}else if(e.indexOf("Charge")>-1){if(_=e.substring("Charge".length),a=s=$.trim($("#charge_command"+_).val()),s=s.replace(/[\[\]]/g,""),g_ussd_currentFun=e,ussd_sms_multi_init(_),null==a||""==a)return showErrorUnderTextbox("charge_hint"+_,ussd_label_hint_wrong_command,"charge_error_msgId_"+_),$(".button_wrapper input").removeClass("disable_btn"),void $(".button_wrapper input").addClass("button_dialog");if($("#charge_error_msgId_"+_).parent().remove(),0==ussd_checkChargeCommand(s,n,_))return}else clearAllErrorLabel();40<a.length?showInfoDialog(IDS_ussd_label_illegal_command_hint):"sms"==g_ussd_send_type?sendCommonBySms(s,t):sendCommonByUssd(s,t)}}function ussd_getResult(){1!=g_ussd_timeout&&getAjaxData("api/ussd/get",(function(e){if(1!=g_ussd_timeout){var s=xml2object(e);if("response"==s.type){if(s=$.trim(s.response.content),0==(s=(s=XSSResolveCannotParseChar(s)).replace(/[\n|\r]/g,"<br/>")).length&&(s=common_failed),"General"==g_ussd_currentFun){var t=$("#general_result_table tr:last").height();general_html+="<tr class='general_result'><td class='general_status clr_cyan'>",general_html+=dialup_label_received+common_colon+"</td><td><pre class='general_content clr_cyan'>",general_html+=s+"</pre></td></tr>",$("#general_result_table").html(general_html);var n=$("#general_result_table").height();t+=$("#general_result_table tr:last").height(),$("#general_result").scrollTop(n-t)}else{if(!(g_ussd_currentFun.indexOf("BalanceInquiry")>-1)){var a="<pre style='white-space: pre-wrap; word-wrap: break-word'>"+s+"</pre>";return clearTimeout(g_ussd_timer_maxDialog),ussdDialogStatusFinished(),void showInfoDialog(a)}var _;_=g_ussd_currentFun.substring("BalanceInquiry".length),balance_html="<pre class = 'ussd_info_result'>"+s+"</pre>",$("#balance_inquiry_result"+_).html(balance_html)}clearTimeout(g_ussd_timer_maxDialog),ussdDialogStatusFinished()}else"111019"==s.error.code?setTimeout(ussd_getResult,g_feature.update_interval):"111020"==s.error.code?(clearTimeout(g_ussd_timer_maxDialog),ussdDialogStatusFinished(),ussd_releaseUssdDialog(),showInfoDialog(common_timeout)):(clearTimeout(g_ussd_timer_maxDialog),ussdDialogStatusFinished(),showInfoDialog(common_failed))}}),{errorCB:function(){clearTimeout(g_ussd_timer_maxDialog),ussdDialogStatusFinished(),showInfoDialog(common_failed)}})}function ussd_getDialogStatus(e,s){getAjaxData("api/ussd/status",(function(t){var n=xml2object(t);"response"==n.type&&(n.response.result==USSD_HAVE_USSD_DIALOG?(0==g_ussd_dialogstatus_finished&&($(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("disable_btn")),"function"==typeof e&&e()):(1==g_ussd_dialogstatus_finished&&(1==g_moduleswitch.vsim_enabled&&2!=vsim_status?($(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("disable_btn")):($(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("button_dialog"))),"function"==typeof s&&s()))}))}function ussd_releaseUssdDialog(){getAjaxData("api/ussd/release",(function(e){var s=xml2object(e);isAjaxReturnOK(s)&&(g_ussd_currentFun=null,1==g_moduleswitch.vsim_enabled&&2!=vsim_status?($(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("disable_btn")):($(".button_wrapper input").removeClass("disable_btn"),$(".button_wrapper input").addClass("button_dialog")))}),{errorCB:function(){}})}function initVsim(){getAjaxData("api/vsim/operateswitch-vsim",(function(e){var s=xml2object(e);if("response"==s.type){var t=s.response;vsim_status=t.vsim_status}}),{sync:!0})}function chang_menuli(){1==g_moduleswitch.vsim_enabled&&2!=vsim_status&&($(".button_wrapper input").removeClass("button_dialog"),$(".button_wrapper input").addClass("disable_btn"),$("input:not(#lang)").attr("disabled",!0),$("select:not(#lang)").attr("disabled",!0))}function creatUssdContent(){"new"==webui_mode&&force_old_ussd?($("#new_smsmenu_list").remove(),$("#new_ussd_command").remove(),$("#new_ussd_receive").remove()):"old"==webui_mode&&force_new_ussd?($(".content").empty(),$(".content").append($("#new_smsmenu_list").detach().attr("style","margin-left: 28px;").show()),$(".content").append($("#new_ussd_command").detach().show()),$(".content").append($("#new_ussd_receive").detach().show())):($("#new_body").append($("#new_smsmenu_list").detach().show()),$("#new_body").append($("#new_ussd_command").detach().show()),$("#new_body").append($("#new_ussd_receive").detach().show())),("new"==webui_mode&&!force_old_ussd||"old"==webui_mode&&force_new_ussd||"pregeneral"==g_ussdLeftmenu[0])&&(clearAllErrorLabel(),ussd_show_General(g_ussd_preconfig.General))}redirectOnCondition(null,"ussd"),ussd_initVar(),Date.prototype.Format=function(e){var s,t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds()};for(s in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+s+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[s]:("00"+t[s]).substr((""+t[s]).length)));return e},$(document).ready((function(){isCGIWorks=getGeneralCGICommandList(!0),1==g_moduleswitch.vsim_enabled&&initVsim(),ussd_initPreClick(),ussd_initPostClick(),ussd_initShow(),ussd_releaseUssdDialog(),g_ussd_status_timer=setInterval((function(){ussd_getDialogStatus()}),g_feature.update_interval),startLogoutTimer(),1==g_moduleswitch.vsim_enabled&&2!=vsim_status&&showInfoDialog(IDS_vsim_function_show)}));var new_unread_sms="New",new_read_sms="Read";if("ru_ru"==LANGUAGE_DATA.current_language)var new_ussd_command_title="Введите команду*",new_ussd_select_tip="*Ввод можно осуществить с помощью клавиатуры",new_ussd_sent_balance="узнать баланс",new_ussd_sent_linit="узнать остаток",new_ussd_sent_num="узнать свой номер",new_ussd_receive_title=" Полезные команды",new_ussd_error_input="Внимание! Неверный USSD-код. Проверьте его и повторите попытку.";else var new_ussd_command_title="Enter the command",new_ussd_select_tip="* Keyboard can be used ",new_ussd_sent_balance="check the balance",new_ussd_sent_linit="check available limit",new_ussd_sent_num="show my number",new_ussd_receive_title="Useful commands",new_ussd_error_input="Warning USSD code is incorrect. Please check the code and try again.";function setUssdText(){$("#new_all_sms a").text(sms_lable_sms),$("#new_ussd a").text(ussd_label_ussd),$("#new_unread_sms a").text(new_unread_sms),$("#new_read_sms a").text(new_read_sms),$("#new_received_sms a").text(IDS_msg_receive),$("#new_sent_sms a").text(msg_sent),$("#new_ussd_command_title").text(new_ussd_command_title),$("#new_ussd_select_tip").text(new_ussd_select_tip),$("#new_ussd_sent").attr("value",common_sent),$("#new_ussd_command_reply > span:first").text(common_reply),$("#new_ussd_receive_title").text(new_ussd_receive_title)}function addUssdEvent(){$("#new_ussd_command_select span").live("click",(function(){var e=$("#general_command_select").sVal();e=e||"";var s=$(this).attr("value");$("#general_command_select").sVal(e+s)})),$("#new_ussd_sent").live("click",(function(){var e=$("#general_command_select").sVal(),s=(e=e||"").substring(0,1),t=e.substring(e.length,e.lastIndexOf("#"));e.substring(1,e.length-1),/^(\*|\#|[0-9])+$/.test(e)&&(e.length>2&&"*"==s&&"#"==t||1==e.length&&"*"!=s&&"#"!=t)?ussd_sendCommand("General","undefined","CodeType","undefined"):showInfoDialog(new_ussd_error_input)})),$("#new_ussd_receive_content > div").live("click",(function(){$("#general_command_select").sVal($(this).attr("data"))}))}$(document).ready((function(){"new"!=webui_mode||force_old_ussd||$("#wrapper").css("display","none"),creatUssdContent(),("new"==webui_mode&&!force_old_ussd||"old"==webui_mode&&force_new_ussd)&&(setUssdText(),addUssdEvent())}));var isCGIWorks=!1;function addGeneralCommand(e,s){var t=JSON.parse(localStorage.ussd_generalCommandList);t.push({Name:e,Command:s}),localStorage.ussd_generalCommandList=JSON.stringify(t),insertGeneralCommandList()}function addGeneralCGICommand(e,s){var t=getGeneralCGICommandList();t.add_cmd_list.push({Name:e,Command:s}),saveGeneralCGICommandList(t),insertGeneralCommandList()}function addGeneralCommandDialog(){call_dialog(ussd_label_add_command,'<table width="570" border="0" cellpadding="0" cellspacing="0"><tr><td height="32">'+common_name+common_colon+'</td><td><input class="input_style" id="input_new_ussd_name" size="20"/></td></tr><tr><td height="32">'+ussd_label_command+common_colon+'</td><td><input class="input_style" id="input_new_ussd_command" size="20"/></td></tr><tr id="tr_new_ussd_cgi" style="display:none;"><td height="32" colspan="2"><input id="input_new_ussd_cgi" type="checkbox"> '+ussd_label_save_to_modem+"</td></tr></table>",common_add,"pop_Add",common_close,"pop_Cancel"),isCGIWorks?$("#tr_new_ussd_cgi").show():$("#tr_new_ussd_cgi").hide(),$("#pop_Add").click((function(){$("#input_new_ussd_cgi").prop("checked")?addGeneralCGICommand($("#input_new_ussd_name").val(),$("#input_new_ussd_command").val()):addGeneralCommand($("#input_new_ussd_name").val(),$("#input_new_ussd_command").val()),$("#input_new_ussd_name").val(""),$("#input_new_ussd_command").val("")}))}function removeGeneralCommand(e){var s=JSON.parse(localStorage.ussd_generalCommandList);s.splice(e,1),localStorage.ussd_generalCommandList=JSON.stringify(s),$("#remove_ussd_list").html(removeGeneralCommandList(!0)),insertGeneralCommandList()}function removeGeneralCGICommand(e){var s=getGeneralCGICommandList();s.add_cmd_list.splice(e,1),saveGeneralCGICommandList(s),$("#remove_ussd_list").html(removeGeneralCommandList(!0)),insertGeneralCommandList()}function removeGeneralDefaultCommand(e,s){if(!0===s)var t=getGeneralCGICommandList(),n=t.rem_def_cmd_list;else n=JSON.parse(localStorage.ussd_generalRemovedDefaultCommandList);n.push(e),!0===s?saveGeneralCGICommandList(t):localStorage.ussd_generalRemovedDefaultCommandList=JSON.stringify(n),$("#remove_ussd_list").html(removeGeneralCommandList(!0)),insertGeneralCommandList()}function removeGeneralCommandDialog(){call_dialog(ussd_label_remove_command,"<p><b>"+ussd_label_click_to_remove+common_colon+"</b></p>"+removeGeneralCommandList()+'<br><div id="div_remove_default_ussd_cgi" style="display:none;"><input id="input_remove_default_ussd_cgi" type="checkbox"> '+ussd_label_remove_default_commands_from_modem+"</div>",common_close,"pop_Cancel"),removeGeneralCommandDialogCGIFlagCheck()}function removeGeneralCommandList(e){var s='<ul id="remove_ussd_list">';return $.each(getGeneralCommandList(JSON.parse(JSON.stringify(g_ussd_preconfig.General))),(function(e,t){"default"==t.Type?s+='<li><a href="javascript:removeGeneralDefaultCommand('+t.n+", $('#input_remove_default_ussd_cgi').prop('checked'));void(0);\">"+t.Name+"</a>":"cgi"==t.Type?s+='<li><a href="javascript:removeGeneralCGICommand('+t.n+');void(0);">'+t.Name+"</a>":"localStorage"==t.Type&&(s+='<li><a href="javascript:removeGeneralCommand('+t.n+');void(0);">'+t.Name+"</a>")})),s+="</ul>",!0===e&&removeGeneralCommandDialogCGIFlagCheck(),s}function removeGeneralCommandDialogCGIFlagCheck(){var e=getGeneralCGICommandList();isCGIWorks?$("#div_remove_default_ussd_cgi").show():$("#div_remove_default_ussd_cgi").hide(),0!=e.rem_def_cmd_list.length&&$("#input_remove_default_ussd_cgi").attr("checked",!0),0==e.rem_def_cmd_list.length&&0==JSON.parse(localStorage.ussd_generalRemovedDefaultCommandList).length||$("#input_remove_default_ussd_cgi").attr("disabled",!0)}function getGeneralCommandList(e){var s=[],t=getGeneralCGICommandList();return"ru_ru"==LANGUAGE_DATA.current_language&&e.RussianMenu?"old"==webui_mode&&!force_new_ussd||"new"==webui_mode&&force_old_ussd||"material"==webui_mode||!e.RussianNewMenu?makeGeneralDefaultCommandList(e.RussianMenu,s,t):makeGeneralDefaultCommandList(e.RussianNewMenu,s,t):"old"==webui_mode&&!force_new_ussd||"new"==webui_mode&&force_old_ussd||"material"==webui_mode||!e.NewMenu?makeGeneralDefaultCommandList(e.Menu,s,t):makeGeneralDefaultCommandList(e.NewMenu,s,t),$.each(t.add_cmd_list,(function(e,t){s.push(formatGeneralCommandList(t,"cgi",e))})),$.each(JSON.parse(localStorage.ussd_generalCommandList),(function(e,t){s.push(formatGeneralCommandList(t,"localStorage",e))})),s}function getGeneralCGICommandList(e){var s;return!0===e?(s=!1,$.ajax({type:"GET",url:"/ussd_cmd_list.json",success:function(e,t,n){void 0!==e.config&&(s=!0)},dataType:"json",async:!1})):(s={add_cmd_list:[],rem_def_cmd_list:[]},$.ajax({type:"GET",url:"/ussd_cmd_list.data.json",success:function(e,t,n){void 0!==e.config&&(s=e.config)},dataType:"json",async:!1})),s}function saveGeneralCGICommandList(e){$.ajax({type:"POST",url:"http://"+location.hostname+":5080/cgi-bin/ussd.cgi?cmd=save_list",data:JSON.stringify({config:e}),processData:!1,dataType:"json",async:!1})}function makeGeneralDefaultCommandList(e,s,t){e&&e.MenuItem&&($.isArray(e.MenuItem)?(0!=t.rem_def_cmd_list.length?$.each(t.rem_def_cmd_list,(function(s,t){e.MenuItem.splice(t,1)})):$.each(JSON.parse(localStorage.ussd_generalRemovedDefaultCommandList),(function(s,t){e.MenuItem.splice(t,1)})),$.each(e.MenuItem,(function(e,t){s.push(formatGeneralCommandList(t,"default",e))}))):0==t.rem_def_cmd_list.length&&0==JSON.parse(localStorage.ussd_generalRemovedDefaultCommandList).length&&s.push(formatGeneralCommandList(e.MenuItem,"default",0)))}function formatGeneralCommandList(e,s,t){return e.Command=$.trim(e.Command),e.Name=$.trim(e.Name),0==e.Name.length?0==e.Command.length?e.Name=null:e.Name=e.Command:0!=e.Command.length&&("new"==webui_mode&&!force_old_ussd||"old"==webui_mode&&force_new_ussd?e.Name=e.Command+" - "+e.Name:("old"==webui_mode&&!force_new_ussd||"new"==webui_mode&&force_old_ussd||"material"==webui_mode)&&(e.Name=e.Name+" ("+e.Command+")")),e.Type=s,e.n=t,e}function insertGeneralCommandList(){g_ussd_generalCommandList.length=0,$.each(getGeneralCommandList(JSON.parse(JSON.stringify(g_ussd_preconfig.General))),(function(e,s){g_ussd_generalCommandList.push([s.Command,s.Name])})),g_ussd_generalCommandList.push([addGeneralCommandDialog,common_add]),g_ussd_generalCommandList.push([removeGeneralCommandDialog,ussd_label_remove]),$("#general_command_select").createSelect({maxlength:40,direction_up:!0,onlyread:!1,maxheight:240}),("old"==webui_mode&&!force_new_ussd||"new"==webui_mode&&force_old_ussd)&&$("#general_command_select").createOptions(g_ussd_generalCommandList),$("#new_ussd_receive_content").empty(),$.each(g_ussd_generalCommandList,(function(e,s){"function"!=typeof s[0]?$("#new_ussd_receive_content").append('<div data="'+s[0]+'">'+s[1]+"</div>"):($("#new_ussd_receive_content").append('<div id="new_ussd_receive_content_'+e+'">'+s[1]+"</div>"),$("#new_ussd_receive_content_"+e).click(s[0]))}))}void 0===localStorage.ussd_generalCommandList&&(localStorage.ussd_generalCommandList=JSON.stringify([])),void 0===localStorage.ussd_generalRemovedDefaultCommandList&&(localStorage.ussd_generalRemovedDefaultCommandList=JSON.stringify([]));

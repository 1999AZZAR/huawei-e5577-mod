var edit_flag=!1,editIndex=-1,chooseContent="<div id='file_path_wrapper' class='file_path_wrapper'><p>"+sd_hint_select_a_folder+"</p><div id='file_tree_wrapper' class='file_tree_wrapper'><div id='file_tree_div' class='file_tree_div'></div></div></div>",ok_flag=0,add_flag=0,MAXLINENEMBER=5,SHAREALLPATH_TYPE="0",USERSHAREPATH_MAXLENGTH=255,folder_path={CurrentPath:""},web_sharing={SDShareMode:"",SDCardShareStatus:"",SDShareFileMode:"",SDAccessType:"",SDSharePath:""},g_usermanege_Data=[],g_back_data=[],g_edit_number=[],g_add_number=[],root_path="/",FILE_LIST_TYPE_FOLDER="0",g_indexnew=0,addIndex=0,showpassword=0;function addUsermanegement(e){var a=null,s=null;a="0"==arguments[2]?sd_label_read_only:sd_label_read_write,s="1"==arguments[3]?IDS_system_samba_share_allpath:arguments[3];var t=null;if(t='<tr class="user_add_line">',t+="<td  width='100px'  style='word-break: break-all;'>"+arguments[1]+"</td>",t+="<td>"+a+"</td>",t+="<td>"+s+"</td>",t+="<td class='user_options'><span class=\"button_edit_list clr_blue\">"+common_edit+'</span><span class="button_urlfilter_delete_list clr_blue">'+common_delete+"</span></td></tr>",edit_flag)$(".user_add_line").eq(editIndex).remove(),0!=editIndex?$(".user_add_line").eq(editIndex-1).after(t):$(e).eq(0).after(t);else{var n=$(e).size();$(e).eq(n-2).after(t)}$(".user_add_line").size()>=MAXLINENEMBER?button_enable("add_item","0"):button_enable("add_item","1")}function addArry(){if(1==g_indexnew)var e={index:"",accountname:"",accountpwd:"",sharepath:"",accesstype:"",shareallpath:""};else e={accountname:"",accountpwd:"",sharepath:"",accesstype:"",shareallpath:""};edit_flag||1!=g_indexnew?edit_flag||1==g_indexnew?(g_usermanege_Data[editIndex].accountname=arguments[0],g_usermanege_Data[editIndex].accountpwd=arguments[1],g_usermanege_Data[editIndex].sharepath=arguments[2],g_edit_number.push(editIndex),g_usermanege_Data[editIndex].accesstype=arguments[3],g_usermanege_Data[editIndex].shareallpath=arguments[4]):(e.accountname=arguments[0],e.accountpwd=arguments[1],e.sharepath=arguments[2],e.accesstype=arguments[3],e.shareallpath=arguments[4],g_add_number.push(g_usermanege_Data.length),g_usermanege_Data.push(e)):(e.index=arguments[0],e.accountname=arguments[1],e.accountpwd=arguments[2],e.sharepath=arguments[3],e.accesstype=arguments[4],e.shareallpath=arguments[5],g_add_number.push(g_usermanege_Data.length),g_usermanege_Data.push(e))}function usermanege_initpage(){g_usermanege_Data=[],g_edit_number=[],g_add_number=[],getAjaxData("api/sdcard/share-account",(function(e){var a=xml2object(e).response.accounts.account;void 0!==a&&null!=a&&(g_usermanege_Data=CreateArray(a),g_back_data=CreateArray(a),void 0!==g_moduleswitch.encrypt_enabled&&1==g_moduleswitch.encrypt_enabled&&$.each(g_usermanege_Data,(function(e){""!=g_usermanege_Data[e].accountname&&null!=g_usermanege_Data[e].accountname&&void 0!==g_usermanege_Data[e].accountname&&(g_usermanege_Data[e].accountpwd=COMMON_PASSWORD_VALUE,g_back_data[e].accountpwd=COMMON_PASSWORD_VALUE)})))}),{sync:!0}),g_usermanege_Data.length>0&&showData()}function displayCustomerTree(e,a){var s,t=a,n="<ul>";s="/"==t?"/":"/"+t.replace(/\*/g,"/"),folder_path.CurrentPath=s;var l=object2xml("request",folder_path);saveAjaxData("api/sdcard/sdfile",l,(function(s){var l=xml2object(s);if("/"==a&&$("#"+e).empty(),"response"==l.type){var r=l.response.FileList.File;if($.isArray(r)){var d=0,_=0;$.each(r,(function(e){FILE_LIST_TYPE_FOLDER==r[e].Type&&d++})),$.each(r,(function(s){if(FILE_LIST_TYPE_FOLDER==r[s].Type){var l="",i="",o="";"/"==a?(o=sd_resolveEntityReference(r[s].Name),l=e+s,i=o):(o=sd_resolveEntityReference(r[s].Name),l=e+s,i=t+"*"+o),i=i.replace(/\'/g,"&#39;"),n+=d-1>_?"<li id='"+l+"' class='sub_folder_li expandable'><div id='list_flag*"+l+"' class='hitarea expandable-hitarea'></div><span  id='folder_"+i+"' class='folder_path_line'><a class='folder_name' href='javascript: void(0)'><pre>"+o+"</pre></a></span></li>":"<li id='"+l+"' class='sub_folder_li expandable lastExpandable'><div id='list_flag*"+l+"' class='hitarea expandable-hitarea lastExpandable-hitarea'></div><span id='folder_"+i+"' class='folder_path_line'><a class='folder_name' href='javascript: void(0)'><pre>"+o+"</pre></a></span></li>",_++}})),"<ul>"==n?$("#"+e).children("div").hasClass("lastExpandable-hitarea")?($("#"+e).children("div").removeClass("hitarea").removeClass("lastExpandable-hitarea").removeClass("collapsable-hitarea").addClass("noSubFolder_last"),$("#"+e).children("span.folder_path_line").css({background:"none"})):($("#"+e).removeClass("expandable").removeClass("collapsable").children("div").removeClass("hitarea").removeClass("expandable-hitarea").removeClass("collapsable-hitarea").addClass("noSubFolder"),$("#"+e).children("span.folder_path_line").css({background:"none"})):$("#"+e).append(n)}else if(void 0!==r)if(FILE_LIST_TYPE_FOLDER==r.Type){var i="",o="",c="";"/"==a?(c=sd_resolveEntityReference(r.Name),i=e+"0",o=c):(c=sd_resolveEntityReference(r.Name),i=e+"0",o=t+"*"+c),o=o.replace(/\'/g,"&#39;"),n+="<li id='"+i+"' class='sub_folder_li expandable lastExpandable'><div id='list_flag*"+i+"' class='hitarea expandable-hitarea lastExpandable-hitarea'></div><span id='folder_"+o+"' class='folder_path_line'><a class='folder_name' href='javascript: void(0)'><pre>"+c+"</pre></a></span></li>",$("#"+e).append(n)}else $("#"+e).children("div").hasClass("lastExpandable-hitarea")?($("#"+e).children("div").removeClass("hitarea").removeClass("lastExpandable-hitarea").removeClass("collapsable-hitarea").addClass("noSubFolder_last"),$("#"+e).children("span.folder_path_line").css({background:"none"})):($("#"+e).removeClass("expandable").removeClass("collapsable").children("div").removeClass("hitarea").removeClass("expandable-hitarea").removeClass("collapsable-hitarea").addClass("noSubFolder"),$("#"+e).children("span.folder_path_line").css({background:"none"}));else $("#"+e).children("div").hasClass("lastExpandable-hitarea")?($("#"+e).children("div").removeClass().addClass("noSubFolder_last"),$("#"+e).children("span.folder_path_line").css({background:"none"})):($("#"+e).removeClass("expandable").removeClass("collapsable").children("div").removeClass().addClass("noSubFolder"),$("#"+e).children("span.folder_path_line").css({background:"none"}))}}),{timeout:3e6})}function setDisplayContent(e){root_path=""==e.SDSharePath?"/":e.SDSharePath,$("#file_path_samba").html("<pre>"+XSSResolveCannotParseChar(root_path)+"</pre>")}function createSubFolderTree(e){$("#"+e).hasClass("lastExpandable")?($("#"+e).addClass("collapsable"),$("#"+e).removeClass("expandable"),$("#"+e).addClass("lastCollapsable"),$("#"+e).removeClass("lastExpandable"),$("#"+e).children("div").addClass("collapsable-hitarea"),$("#"+e).children("div").removeClass("expandable-hitarea"),$("#"+e).addClass("loaded_sublist")):($("#"+e).addClass("collapsable"),$("#"+e).removeClass("expandable"),$("#"+e).children("div").addClass("collapsable-hitarea"),$("#"+e).children("div").removeClass("expandable-hitarea"),$("#"+e).addClass("loaded_sublist"))}function showSubFolderTree(e){$("#"+e).hasClass("lastExpandable")?($("#"+e).addClass("collapsable"),$("#"+e).removeClass("expandable"),$("#"+e).addClass("lastCollapsable"),$("#"+e).removeClass("lastExpandable"),$("#"+e).children("div").addClass("collapsable-hitarea"),$("#"+e).children("div").removeClass("expandable-hitarea"),$("#"+e).children("ul").css({display:"block"})):($("#"+e).addClass("collapsable"),$("#"+e).removeClass("expandable"),$("#"+e).children("div").addClass("collapsable-hitarea"),$("#"+e).children("div").removeClass("expandable-hitarea"),$("#"+e).children("ul").css({display:"block"}))}function hideSubFolderTree(e){$("#"+e).hasClass("lastCollapsable")?($("#"+e).addClass("expandable"),$("#"+e).removeClass("collapsable"),$("#"+e).addClass("lastExpandable"),$("#"+e).removeClass("lastCollapsable"),$("#"+e).children("div").addClass("expandable-hitarea"),$("#"+e).children("div").removeClass("collapsable-hitarea"),$("#"+e).children("ul").css({display:"none"})):($("#"+e).addClass("expandable"),$("#"+e).removeClass("collapsable"),$("#"+e).children("div").addClass("expandable-hitarea"),$("#"+e).children("div").removeClass("collapsable-hitarea"),$("#"+e).children("ul").css({display:"none"}))}function checkName_pwd(e,a,s){clearAllErrorLabel();var t=!0;if(""==e)return showErrorUnderTextbox("usermanege_name",settings_hint_user_name_empty),$("#usermanege_name").val(""),$("#usermanege_name").focus(),!1;if(edit_flag&&0==showpassword){if(""==a&&""!=e)return showErrorUnderTextbox("usermanege_password",dialup_hint_password_empty),$("#usermanege_password").val(""),$("#confirm_password").val(""),$("#usermanege_password").focus(),!1;if(!samba_checkusername(e))return showErrorUnderTextbox("usermanege_name",IDS_share_samba_username_limit),$("#usermanege_name").val(""),$("#usermanege_name").focus(),!1}else{if(""==a&&""!=e)return showErrorUnderTextbox("usermanege_password",dialup_hint_password_empty),$("#usermanege_password").val(""),$("#confirm_password").val(""),$("#usermanege_password").focus(),!1;if(""==s)return showErrorUnderTextbox("confirm_password",system_hint_new_confirm_password_empty),$("#confirm_password").focus(),!1;if(a!=s)return showErrorUnderTextbox("confirm_password",system_hint_new_and_confirm_pwd_same),$("#usermanege_password").val(""),$("#confirm_password").val(""),$("#usermanege_password").focus(),!1;if(!samba_checkusername(e))return showErrorUnderTextbox("usermanege_name",IDS_share_samba_username_limit),$("#usermanege_name").val(""),$("#usermanege_name").focus(),!1;if(!samba_checkpwd(a))return showErrorUnderTextbox("usermanege_password",IDS_share_samba_password_limit),$("#usermanege_password").val(""),$("#confirm_password").val(""),$("#usermanege_password").focus(),!1}return edit_flag||$(g_usermanege_Data).each((function(a){e==g_usermanege_Data[a].accountname&&(showErrorUnderTextbox("usermanege_name",IDS_system_samba_userName_same),t=!1)})),t}function showData(){$(".user_add_line").remove(),$(g_usermanege_Data).each((function(e){var a=XSSResolveCannotParseChar(g_usermanege_Data[e].accountname);if(g_usermanege_Data[e].shareallpath==SHAREALLPATH_TYPE){var s=XSSResolveCannotParseChar(g_usermanege_Data[e].sharepath);addUsermanegement($("#service_list tr"),a,g_usermanege_Data[e].accesstype,s)}else{var t=XSSResolveCannotParseChar(g_usermanege_Data[e].shareallpath);addUsermanegement($("#service_list tr"),a,g_usermanege_Data[e].accesstype,t)}}))}function checkaddData(){var e=$.trim($("#usermanege_name").val()),a=$("#usermanege_rigth option:selected").val(),s=$("#usermanege_path option:selected").val(),t=$("#usermanege_password").val(),n=$("#confirm_password").val(),l=$("#file_path_samba").children().text();return!!checkName_pwd(e,t,n)&&(s==SHAREALLPATH_TYPE?addUsermanegement($("#service_list tr"),e,a,l):(s.length>USERSHAREPATH_MAXLENGTH&&(s=s.substring(0,USERSHAREPATH_MAXLENGTH-1)),addUsermanegement($("#service_list tr"),e,a,s)),hideAddItemControl(),1!=g_indexnew||edit_flag?addArry(e,t,l,a,s):addArry(addIndex,e,t,l,a,s),edit_flag=!1,showpassword=0,button_enable("apply_button","1"),$("#userEdit").hide(),!0)}function usermanege_validateuserName(){clearAllErrorLabel();var e=arguments[0],a=arguments[1],s=!0;return $(g_usermanege_Data).each((function(t){e!=t&&g_usermanege_Data[t].accountname==a&&(showErrorUnderTextbox("usermanege_name",IDS_system_samba_userName_same),s=!1)})),s}function postData(){showWaitingDialog(common_waiting,updating_label_updating);var e=0,a=0,s=0,t=g_usermanege_Data;if(g_usermanege_Data.length>0){for(e=0;e<g_usermanege_Data.length;e++)if(g_edit_number.length>0)for(a=0;a<g_edit_number.length;a++)e==g_edit_number[a]&&(g_usermanege_Data[e].shareallpath==SHAREALLPATH_TYPE?t[e].sharepath=g_usermanege_Data[e].sharepath:t[e].shareallpath=g_usermanege_Data[e].shareallpath);else if(g_add_number.length>0)for(s=0;s<g_add_number.length;s++)e==g_add_number[s]&&(g_usermanege_Data[e].shareallpath==SHAREALLPATH_TYPE?t[e].sharepath=g_usermanege_Data[e].sharepath:t[e].shareallpath=g_usermanege_Data[e].shareallpath);else g_usermanege_Data[e].shareallpath==SHAREALLPATH_TYPE?t[e].sharepath=g_usermanege_Data[e].sharepath:t[e].shareallpath=g_usermanege_Data[e].shareallpath;for(e=0;e<t.length;e++)t[e].shareallpath==SHAREALLPATH_TYPE?t[e].sharepath=XSSResolveCannotParseChar(t[e].sharepath):t[e].shareallpath=XSSResolveCannotParseChar(t[e].shareallpath)}var n={accounts:{account:t}};$.each(g_usermanege_Data,(function(e){void 0!==g_back_data[e]&&void 0!==g_back_data[e].accountpwd&&g_usermanege_Data[e].accountpwd==COMMON_PASSWORD_VALUE&&delete n.accounts.account[e].accountpwd}));var l=object2xml("request",n);saveAjaxData("api/sdcard/share-account",l,(function(e){var a=xml2object(e);isAjaxReturnOK(a)?(closeWaitingDialog(),showInfoDialog(common_success),button_enable("apply_button","0"),usermanege_initpage()):(closeWaitingDialog(),showInfoDialog(common_failed),usermanege_initpage())}),{enc:!0})}function samba_checkusername(e){var a=!0;new RegExp("^[-a-zA-Z%()#!{}][-a-zA-Z0-9%()#!_{}]{0,63}$").test(e)||(a=!1);var s=e.toLowerCase();return"root"!=s&&"support"!=s&&"admin"!=s&&"nobody"!=s&&"anonymous"!=s||(a=!1),a}function samba_checkpwd(e){var a=!0;return new RegExp("^[a-zA-Z0-9_]{8,63}$").test(e)||(a=!1),a}$(document).ready((function(){clickPasswordEvent("usermanege_password",0),openPortToCss("service_list"),void 0!==g_moduleswitch.encrypt_enabled&&(g_indexnew=g_moduleswitch.encrypt_enabled),usermanege_initpage(),setDisplayContent(web_sharing),$(".user_add_line").size()>=MAXLINENEMBER?button_enable("add_item","0"):button_enable("add_item","1"),button_enable("apply_button","0"),$("#add_item").click((function(){1==g_indexnew&&(addIndex=0==g_usermanege_Data.length?0:parseInt(g_usermanege_Data[g_usermanege_Data.length-1].index,10)+1),isButtonEnable("add_item")&&($("#userEdit").show(),clearAllErrorLabel(),$("#usermanege_name").val(""),$("#usermanege_password").val(""),$("#confirm_password").val(""),showAddItemControl(),$("#usermanege_name").focus(),button_enable("apply_button","0"),$("#usermanege_path").val()==SHAREALLPATH_TYPE?($("#userpath_select").show(),$("#userpath_note").show(),$("#allpath_note").hide()):($("#userpath_select").hide(),$("#userpath_note").hide(),$("#allpath_note").show()))})),$(".button_edit_list").live("click",(function(){mousedownIndexList=[],clearAllErrorLabel(),$(".add_item_control:hidden").size()>0&&$("#edit_item_ok").size()<1&&($("#userEdit").show(),editIndex=$(".button_edit_list").index(this),$(this).parent().html('<a id="edit_item_ok" class="clr_blue" href="javascript:void(0);">'+common_ok+'</a><a id="edit_item_cancel" class="clr_blue" href="javascript:void(0);">'+common_cancel+"</a>"),$("#usermanege_name").val(g_usermanege_Data[editIndex].accountname),$("#usermanege_password").val(g_usermanege_Data[editIndex].accountpwd),$("#confirm_password").val(g_usermanege_Data[editIndex].accountpwd),$("#usermanege_rigth").val(g_usermanege_Data[editIndex].accesstype),$("#usermanege_path").val(g_usermanege_Data[editIndex].shareallpath),$("#file_path_samba").children().html(g_usermanege_Data[editIndex].sharepath),$("#usermanege_path").val()==SHAREALLPATH_TYPE?($("#userpath_select").show(),$("#userpath_note").show(),$("#allpath_note").hide()):($("#userpath_select").hide(),$("#userpath_note").hide(),$("#allpath_note").show()),hideAddItemControl(),edit_flag=!0,$("#usermanege_password,#confirm_password").live("mousedown focusin click",(function(){0==showpassword&&($("#usermanege_password").val(""),$("#confirm_password").val(""),showpassword=1)})),$("#edit_item_cancel").live("click",(function(){$(".user_add_line").eq(editIndex).html(null),$("#userEdit").hide(),showpassword=0,-1!=editIndex&&("0"==g_usermanege_Data[editIndex].shareallpath?addUsermanegement($("#service_list tr"),g_usermanege_Data[editIndex].accountname,g_usermanege_Data[editIndex].accesstype,g_usermanege_Data[editIndex].sharepath):addUsermanegement($("#service_list tr"),g_usermanege_Data[editIndex].accountname,g_usermanege_Data[editIndex].accesstype,g_usermanege_Data[editIndex].shareallpath))})),button_enable("apply_button","0"),button_enable("add_item","0"))})),$("#add_item_cancel").live("click",(function(){return hideAddItemControl(),$("#userEdit").hide(),1!=add_flag&&1!=ok_flag||button_enable("apply_button","1"),!1})),$("#edit_item_ok").live("click",(function(){usermanege_validateuserName(editIndex,$.trim($("#usermanege_name").val()))&&checkaddData()&&($(this).parent().html('<span class="button_edit_list clr_blue">'+common_edit+'</span><span class="button_urlfilter_delete_list clr_blue">'+common_delete+"</span>"),button_enable("apply_button","1"),$(".user_add_line").size()>=MAXLINENEMBER?button_enable("add_item","0"):button_enable("add_item","1"),ok_flag=1,edit_flag=!1,editIndex=-1)})),$("#add_item_ok").live("click",(function(){editIndex=-1,edit_flag=!1,checkaddData(),add_flag=1})),$("#usermanege_path").change((function(){$("#file_path_samba").children().html("/"),$("#usermanege_path").val()==SHAREALLPATH_TYPE?($("#userpath_select").show(),$("#userpath_note").show(),$("#allpath_note").hide()):($("#userpath_select").hide(),$("#userpath_note").hide(),$("#allpath_note").show())})),$("#custom_path").click((function(){call_dialog(sd_hint_select_a_folder,chooseContent,common_ok,"path_dialog_ok",common_cancel,"path_dialog_cancel"),displayCustomerTree("file_tree_div","/"),button_enable("path_dialog_ok","0"),button_enable("web_share_apply","1")})),$("#path_dialog_ok").live("click",(function(){if(isButtonEnable("path_dialog_ok")){var e=$("a.focusfolder").closest("span").attr("id");void 0!==e?(e="/"+(e=(e=e.substring(e.indexOf("_")+1)).replace(/\*/g,"/")),$(".dialog, .info_dialog").fadeOut((function(){0==$(".info_dialog").size()&&$("#div_wrapper").hide()})),$("#file_path_samba").html("<pre>"+XSSResolveCannotParseChar(e)+"</pre>"),$("#wait_table").remove(),0==$(".info_dialog").size()&&$("#div_wrapper").hide()):$(".dialog, .info_dialog").fadeOut((function(){0==$(".info_dialog").size()&&$("#div_wrapper").hide()}))}})),$("#path_dialog_cancel").live("click",(function(){$(".dialog, .info_dialog").fadeOut((function(){0==$(".info_dialog").size()&&$("#div_wrapper").hide()}))})),$("a.folder_name").live("mouseover",(function(){$(this).addClass("folder_hover")})),$("a.folder_name").live("mouseout",(function(){$(this).removeClass("folder_hover")})),$("a.folder_name").live("click",(function(){0==$(this).hasClass("focusfolder")&&($("a.focusfolder").removeClass("focusfolder"),$(this).addClass("focusfolder"))})),$(".sub_folder_li").live("click",(function(){button_enable("path_dialog_ok","1")})),$("div.hitarea").live("click",(function(){var e=$(this).closest("li").attr("id"),a=$(this).next().attr("id");a=(a=a.substring(a.indexOf("_")+1)).replace(/\&/g,"&amp;"),$("#"+e).hasClass("expandable")&&!$("#"+e).hasClass("loaded_sublist")?(displayCustomerTree(e,a),createSubFolderTree(e),$("#"+e).children("div").hasClass("noSubFolder")?$("#"+e).children("span.folder_path_line").css({background:"none"}):$("#"+e).children("span.folder_path_line").css({background:"url(../res/treeview-default-line.gif) 0 0 repeat-y"})):$("#"+e).hasClass("expandable")&&$("#"+e).hasClass("loaded_sublist")?(showSubFolderTree(e),$("#"+e).children("span.folder_path_line").css({background:"url(../res/treeview-default-line.gif) 0 0 repeat-y"})):(hideSubFolderTree(e),$("#"+e).children("span.folder_path_line").css({background:"none"}))})),$(".button_urlfilter_delete_list").live("click",(function(){if($(".add_item_control:hidden").size()>0&&$("#edit_item_ok").size()<1){var e=$(".button_urlfilter_delete_list").index(this);call_dialog(common_delete,firewall_hint_delete_list_item,common_ok,"pop_OK",common_cancel,"pop_Cancel"),$("#pop_OK").click((function(){deleteFilter(e,$(".user_add_line")),g_usermanege_Data.splice(e,1),clearDialog_table(),button_enable("apply_button","1"),button_enable("add_item","1")}))}})),$("#apply_button").click((function(){isButtonEnable("apply_button")&&(showConfirmDialog(firewall_hint_submit_list_item,postData),edit_flag=!1,editIndex=-1),ok_flag=0,add_flag=0}))}));
